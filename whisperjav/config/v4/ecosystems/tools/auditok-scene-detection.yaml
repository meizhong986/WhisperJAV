# =============================================================================
# Auditok Scene Detection Tool Configuration
# =============================================================================
# Audio-based scene splitting using energy/silence detection.
# Two-pass segmentation with audio preprocessing for reliable results.
# =============================================================================

schemaVersion: v1
kind: Tool

metadata:
  name: auditok-scene-detection
  displayName: "Auditok Scene Detection"
  description: |
    Audio-based scene splitting using silence detection with two-pass segmentation.
    Uses energy thresholds to detect speech vs silence boundaries.
    Reliable for most content types including JAV audio.
  version: "1.0.0"
  tags:
    - scene-detection
    - auditok
    - energy-based
    - reliable
    - default

tool_type: scene_detection

# =============================================================================
# Input/Output Contract
# =============================================================================
contract:
  input:
    audio_path: path
    sample_rate: int
  output:
    segments: list  # List of {start: float, end: float}

# =============================================================================
# Tool Parameters
# =============================================================================
spec:
  # --- Core Options ---
  max_duration_s: 29.0
  min_duration_s: 0.2
  target_sr: 16000
  force_mono: true
  preserve_original_sr: true
  verbose_summary: true

  # --- Pass 1: Coarse Segmentation ---
  pass1_min_duration_s: 2.0
  pass1_max_duration_s: 2700.0
  pass1_max_silence_s: 2.5
  pass1_energy_threshold: 32

  # --- Pass 2: Fine Segmentation ---
  pass2_min_duration_s: 0.1
  pass2_max_duration_s: 1800.0
  pass2_max_silence_s: 1.8
  pass2_energy_threshold: 38

  # --- Audio Preprocessing ---
  bandpass_low_hz: 200
  bandpass_high_hz: 4000
  drc_threshold_db: -24.0
  drc_ratio: 4.0
  drc_attack_ms: 5.0
  drc_release_ms: 100.0

  # --- Fallback Options ---
  brute_force_fallback: true
  brute_force_chunk_s: 29.0
  pad_edges_s: 0.0
  fade_ms: 0

# =============================================================================
# Sensitivity Presets
# =============================================================================
presets:
  conservative:
    # Higher thresholds, fewer splits
    pass1_energy_threshold: 40
    pass2_energy_threshold: 45
    pass1_max_silence_s: 3.0
    pass2_max_silence_s: 2.5

  balanced: {}

  aggressive:
    # Lower thresholds, more splits
    pass1_energy_threshold: 28
    pass2_energy_threshold: 32
    pass1_max_silence_s: 2.0
    pass2_max_silence_s: 1.2

# =============================================================================
# GUI Hints
# =============================================================================
gui:
  max_duration_s:
    widget: slider
    label: "Max Scene Duration"
    description: "Maximum scene duration in seconds"
    min: 10
    max: 120
    step: 1
    group: core

  min_duration_s:
    widget: number
    label: "Min Scene Duration"
    description: "Minimum scene duration in seconds"
    min: 0.1
    max: 5.0
    step: 0.1
    group: core

  pass1_max_duration_s:
    widget: number
    label: "Pass 1 Max Duration"
    description: "Maximum scene duration for coarse segmentation (seconds)"
    min: 60
    max: 3600
    step: 60
    group: pass1

  pass1_max_silence_s:
    widget: number
    label: "Pass 1 Max Silence"
    description: "Maximum silence before split (seconds)"
    min: 0.5
    max: 10.0
    step: 0.1
    group: pass1

  pass1_energy_threshold:
    widget: slider
    label: "Pass 1 Energy Threshold"
    description: "Energy threshold for coarse segmentation (dB)"
    min: 10
    max: 60
    step: 1
    group: pass1

  pass2_max_duration_s:
    widget: number
    label: "Pass 2 Max Duration"
    description: "Maximum scene duration for fine segmentation (seconds)"
    min: 60
    max: 3600
    step: 60
    group: pass2

  pass2_max_silence_s:
    widget: number
    label: "Pass 2 Max Silence"
    description: "Maximum silence before split (seconds)"
    min: 0.5
    max: 5.0
    step: 0.1
    group: pass2

  pass2_energy_threshold:
    widget: slider
    label: "Pass 2 Energy Threshold"
    description: "Energy threshold for fine segmentation (dB)"
    min: 10
    max: 60
    step: 1
    group: pass2

  brute_force_fallback:
    widget: toggle
    label: "Brute Force Fallback"
    description: "Use fixed chunking as fallback when scene detection fails"
    group: fallback

  brute_force_chunk_s:
    widget: number
    label: "Fallback Chunk Size"
    description: "Fixed chunk size in seconds when brute force fallback is active"
    min: 10
    max: 120
    step: 1
    group: fallback

# Implementation provider
provider:
  module: whisperjav.modules.scene_detection
  class: AuditokSceneDetector
