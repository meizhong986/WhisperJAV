# =============================================================================
# Silero VAD Speech Segmentation Tool Configuration
# =============================================================================
# Neural VAD using Silero model for speech boundary detection.
# High-quality detection with sensitivity presets for different use cases.
# =============================================================================

schemaVersion: v1
kind: Tool

metadata:
  name: silero-speech-segmentation
  displayName: "Silero VAD"
  description: |
    Speech segmentation using Silero VAD neural network.
    Fast, accurate voice activity detection with configurable sensitivity.
    Supports version 4.0 (default) and 3.1 for backward compatibility.
  version: "1.0.0"
  tags:
    - speech-segmentation
    - silero
    - vad
    - neural
  dependencies:
    - "silero-vad"

tool_type: speech_segmentation

# =============================================================================
# Input/Output Contract
# =============================================================================
contract:
  input:
    audio: "np.ndarray | Path | str"
    sample_rate: int
  output:
    segments: "List[SpeechSegment]"
    groups: "List[List[SpeechSegment]]"

# =============================================================================
# Tool Parameters (Balanced preset as default)
# =============================================================================
spec:
  # --- Model Version ---
  version: "v4.0"  # v4.0 (default) or v3.1 for backward compatibility

  # --- Core VAD Parameters ---
  vad.threshold: 0.18
  vad.neg_threshold: 0.15
  vad.min_speech_duration_ms: 100
  vad.max_speech_duration_s: 11.0
  vad.min_silence_duration_ms: 300
  vad.speech_pad_ms: 400

  # --- Segment Grouping ---
  chunk_threshold_s: 4.0

# =============================================================================
# Sensitivity Presets
# =============================================================================
presets:
  # Conservative: Higher thresholds, fewer false positives
  # Best for: Clean audio, clear speech, minimal background noise
  conservative:
    vad.threshold: 0.35
    vad.neg_threshold: 0.3
    vad.min_speech_duration_ms: 150
    vad.max_speech_duration_s: 9.0
    vad.min_silence_duration_ms: 300
    vad.speech_pad_ms: 400

  # Balanced: Default settings for general use
  # Best for: Mixed content, typical audio quality
  balanced: {}  # Uses spec defaults

  # Aggressive: Lower thresholds, maximum detail capture
  # Best for: Difficult audio, soft speech, noisy backgrounds
  aggressive:
    vad.threshold: 0.05
    vad.neg_threshold: 0.1
    vad.min_speech_duration_ms: 30
    vad.max_speech_duration_s: 14.0
    vad.min_silence_duration_ms: 300
    vad.speech_pad_ms: 600

# =============================================================================
# GUI Hints
# =============================================================================
gui:
  version:
    widget: dropdown
    label: "Model Version"
    description: "Silero VAD model version (v4.0 recommended)"
    options:
      - "v4.0"
      - "v3.1"
    group: model

  vad.threshold:
    widget: slider
    label: "Speech Threshold"
    description: "Probability threshold to detect speech (lower = more sensitive)"
    min: 0.01
    max: 0.5
    step: 0.01
    group: detection

  vad.neg_threshold:
    widget: slider
    label: "Negative Threshold"
    description: "Threshold for speech deactivation (lower = extend speech)"
    min: 0.01
    max: 0.5
    step: 0.01
    group: detection

  vad.min_speech_duration_ms:
    widget: spinner
    label: "Min Speech Duration (ms)"
    description: "Minimum speech segment duration to keep"
    min: 10
    max: 500
    step: 10
    group: filters

  vad.max_speech_duration_s:
    widget: slider
    label: "Max Speech Duration (s)"
    description: "Maximum speech segment duration before split"
    min: 5.0
    max: 30.0
    step: 0.5
    group: filters

  vad.min_silence_duration_ms:
    widget: spinner
    label: "Min Silence Duration (ms)"
    description: "Minimum silence duration to trigger split"
    min: 100
    max: 1000
    step: 50
    group: filters

  vad.speech_pad_ms:
    widget: spinner
    label: "Speech Padding (ms)"
    description: "Padding added around detected speech segments"
    min: 0
    max: 1000
    step: 50
    group: filters

  chunk_threshold_s:
    widget: slider
    label: "Group Gap Threshold (s)"
    description: "Maximum gap to group consecutive segments"
    min: 1.0
    max: 10.0
    step: 0.5
    group: grouping

# =============================================================================
# Provider Configuration
# =============================================================================
provider:
  module: whisperjav.modules.speech_segmentation.backends.silero
  class: SileroSpeechSegmenter
