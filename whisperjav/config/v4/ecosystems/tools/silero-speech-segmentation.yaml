# =============================================================================
# Silero VAD Speech Segmentation Tool Configuration
# =============================================================================
# Neural VAD using Silero model for speech boundary detection.
# High-quality detection with sensitivity presets for different use cases.
#
# Version is selected via the backend dropdown (Silero v4.0 vs v3.1), not a
# parameter. Defaults shown are for v4.0.
# =============================================================================

schemaVersion: v1
kind: Tool

metadata:
  name: silero-speech-segmentation
  displayName: "Silero VAD"
  description: |
    Speech segmentation using Silero VAD neural network.
    Fast, accurate voice activity detection with configurable sensitivity.
    Version is selected via the backend dropdown (Silero v4.0 vs v3.1),
    not a parameter. Defaults shown are for v4.0.
  version: "1.0.0"
  tags:
    - speech-segmentation
    - silero
    - vad
    - neural
  dependencies:
    - "silero-vad"

tool_type: speech_segmentation

# =============================================================================
# Input/Output Contract
# =============================================================================
contract:
  input:
    audio: "np.ndarray | Path | str"
    sample_rate: int
  output:
    segments: "List[SpeechSegment]"
    groups: "List[List[SpeechSegment]]"

# =============================================================================
# Tool Parameters (Balanced preset as default)
# =============================================================================
spec:
  # --- Core VAD Parameters ---
  # Keys are flat (no "vad." prefix) to match the routing layer (SEGMENTER_PARAMS)
  threshold: 0.18
  min_speech_duration_ms: 100
  min_silence_duration_ms: 300
  speech_pad_ms: 400

  # --- Segment Grouping ---
  chunk_threshold_s: 2.5
  max_group_duration_s: 29.0  # Upper bound to stay within Whisper's 30s context window

# =============================================================================
# Sensitivity Presets
# =============================================================================
presets:
  # Conservative: Higher thresholds, fewer false positives
  # Best for: Clean audio, clear speech, minimal background noise
  conservative:
    threshold: 0.35
    min_speech_duration_ms: 150
    min_silence_duration_ms: 300
    speech_pad_ms: 400

  # Balanced: Default settings for general use
  # Best for: Mixed content, typical audio quality
  balanced: {}  # Uses spec defaults

  # Aggressive: Lower thresholds, maximum detail capture
  # Best for: Difficult audio, soft speech, noisy backgrounds
  aggressive:
    threshold: 0.05
    min_speech_duration_ms: 30
    min_silence_duration_ms: 300
    speech_pad_ms: 600

# =============================================================================
# GUI Hints
# =============================================================================
# Only functional, routable parameters are exposed here.
# Removed from GUI (not passed to Silero API by backend code):
#   - neg_threshold: stored but excluded from Silero API call (silero.py lines 266-274)
#   - max_speech_duration_s: stored but excluded from Silero API call
#   - version: controlled by factory name (silero vs silero-v3.1), not a parameter
gui:
  threshold:
    widget: slider
    label: "Speech Threshold"
    description: "Probability threshold to detect speech (lower = more sensitive)"
    min: 0.01
    max: 0.5
    step: 0.01
    group: detection

  min_speech_duration_ms:
    widget: spinner
    label: "Min Speech Duration (ms)"
    description: "Minimum speech segment duration to keep"
    min: 10
    max: 500
    step: 10
    group: filters

  min_silence_duration_ms:
    widget: spinner
    label: "Min Silence Duration (ms)"
    description: "Minimum silence duration to trigger split"
    min: 100
    max: 1000
    step: 50
    group: filters

  speech_pad_ms:
    widget: spinner
    label: "Speech Padding (ms)"
    description: "Padding added around detected speech segments"
    min: 0
    max: 1000
    step: 50
    group: filters

  chunk_threshold_s:
    widget: slider
    label: "Group Gap Threshold (s)"
    description: "Maximum gap to group consecutive segments"
    min: 1.0
    max: 10.0
    step: 0.5
    group: grouping

  max_group_duration_s:
    widget: slider
    label: "Max Group Duration (s)"
    description: "Maximum duration for a segment group (prevents exceeding Whisper's 30s context window)"
    min: 10.0
    max: 60.0
    step: 1.0
    group: grouping

# =============================================================================
# Provider Configuration
# =============================================================================
provider:
  module: whisperjav.modules.speech_segmentation.backends.silero
  class: SileroSpeechSegmenter
