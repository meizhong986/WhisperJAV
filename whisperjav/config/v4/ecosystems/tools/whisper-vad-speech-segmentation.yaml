# =============================================================================
# Whisper VAD Speech Segmentation Tool Configuration
# =============================================================================
# Speech segmentation using Whisper transcription timestamps.
# Leverages Whisper's semantic understanding for robust speech detection.
# Works well on low SNR audio where traditional VADs fail.
#
# Model variant is selected via the backend dropdown (whisper-vad, whisper-vad-tiny,
# etc.), not a parameter. Detection thresholds (no_speech_threshold, logprob_threshold)
# are set via the Provider tab as they share parameter names with the ASR engine.
# =============================================================================

schemaVersion: v1
kind: Tool

metadata:
  name: whisper-vad-speech-segmentation
  displayName: "Whisper VAD"
  description: |
    Speech segmentation using Whisper model as neural VAD.
    Transcription segments become speech regions, leveraging Whisper's
    deep semantic understanding for robust detection on difficult audio.
    Model variant is selected via the backend dropdown. Detection thresholds
    (no_speech_threshold, logprob_threshold) are set via the Provider tab
    as they share parameter names with the ASR engine.
  version: "1.0.0"
  tags:
    - speech-segmentation
    - whisper
    - vad
    - semantic
    - neural
  dependencies:
    - "faster-whisper"

tool_type: speech_segmentation

# =============================================================================
# Input/Output Contract
# =============================================================================
contract:
  input:
    audio: "np.ndarray | Path | str"
    sample_rate: int
  output:
    segments: "List[SpeechSegment]"
    groups: "List[List[SpeechSegment]]"
    metadata:
      transcription_cached: bool  # True if cached for future ASR use

# =============================================================================
# Tool Parameters (Balanced preset as default)
# =============================================================================
spec:
  # --- Model Variant ---
  # Controlled by factory name (whisper-vad, whisper-vad-tiny, etc.), not this param.
  # Kept in spec for direct API/CLI use.
  variant: "whisper-vad"

  # --- Detection Parameters ---
  # These collide with PROVIDER_PARAMS_COMMON and route to ASR, not segmenter.
  # Kept in spec for direct API/CLI use but hidden from GUI.
  no_speech_threshold: 0.6
  logprob_threshold: -1.0
  language: "ja"

  # --- Processing ---
  compute_type: "auto"  # Match code default; "auto" selects best for hardware
  device: "auto"
  cache_results: true

  # --- Segment Filtering/Grouping ---
  chunk_threshold_s: 2.5
  min_speech_duration_ms: 100
  max_group_duration_s: 29.0  # Upper bound to stay within Whisper's 30s context window

# =============================================================================
# Sensitivity Presets
# =============================================================================
presets:
  # Conservative: Higher thresholds, fewer false positives
  # Best for: Clean audio, clear speech
  conservative:
    no_speech_threshold: 0.7
    logprob_threshold: -0.8
    min_speech_duration_ms: 150

  # Balanced: Default settings for general use
  balanced: {}  # Uses spec defaults

  # Aggressive: Lower thresholds, maximum capture
  # Best for: Difficult audio, soft speech, low SNR
  aggressive:
    no_speech_threshold: 0.5
    logprob_threshold: -1.5
    min_speech_duration_ms: 50

# =============================================================================
# GUI Hints
# =============================================================================
# Only functional, routable parameters are exposed here.
# Removed from GUI (collision with other routing categories or factory-controlled):
#   - variant: controlled by factory name (whisper-vad, whisper-vad-tiny, etc.)
#   - no_speech_threshold: collides with PROVIDER_PARAMS_COMMON, routes to ASR
#   - logprob_threshold: collides with PROVIDER_PARAMS_COMMON, routes to ASR
#   - language: collides with DECODER_PARAMS, routes to ASR
#   - compute_type: handled at pass level, no segmenter routing path
gui:
  chunk_threshold_s:
    widget: slider
    label: "Group Gap Threshold (s)"
    description: "Maximum gap to group consecutive segments"
    min: 1.0
    max: 10.0
    step: 0.5
    group: filters

  min_speech_duration_ms:
    widget: spinner
    label: "Min Speech Duration (ms)"
    description: "Minimum speech segment duration to keep"
    min: 10
    max: 500
    step: 10
    group: filters

  max_group_duration_s:
    widget: slider
    label: "Max Group Duration"
    description: "Maximum duration for grouped segments (Whisper 30s context limit)"
    min: 10
    max: 60
    step: 1
    unit: "s"
    group: filters

  cache_results:
    widget: toggle
    label: "Cache Results"
    description: "Save transcription for potential reuse by ASR"
    group: processing

# =============================================================================
# Provider Configuration
# =============================================================================
provider:
  module: whisperjav.modules.speech_segmentation.backends.whisper_vad
  class: WhisperVadSpeechSegmenter
